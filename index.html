<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Интерактивное Меню Кофейни v2</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <style>
        /* Сброс стилей и базовые настройки */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary-color: #6F4E37; /* Кофейный */
            --secondary-color: #F5F5DC; /* Бежевый */
            --accent-color: #E0A96D; /* Светло-коричневый / Золотистый */
            --text-color: #333;
            --white-color: #FFFFFF;
            --success-color: #4CAF50;
            --error-color: #dc3545; /* Красный для ошибок */
            --disabled-color: #cccccc;
            --transition-speed: 0.4s;
            --transition-speed-fast: 0.2s;
            --border-radius: 15px;
            --border-radius-small: 8px;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Общий контейнер */
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            width: 100%;
            flex-grow: 1;
            display: flex; /* Changed to flex */
            flex-direction: column; /* Ensure column layout */
            position: relative; /* For view transitions */
            overflow: hidden; /* Clip views during transition */
        }

        /* Шапка */
        header {
            background-color: var(--primary-color);
            color: var(--white-color);
            padding: 15px 60px 15px 15px;
            text-align: center;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            animation: slideDown 0.5s ease-out;
            position: relative;
        }

        header h1 {
            font-size: 1.8em;
            font-weight: 600;
            margin: 0;
            line-height: 1.2;
        }

        /* Кнопка Корзины */
        .btn-cart {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 15px;
            padding: 8px 12px;
            background-color: var(--accent-color);
            color: var(--white-color);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 101;
        }
        .btn-cart:hover {
            background-color: #c89053;
            transform: translateY(-50%) scale(1.05);
        }
        #cart-count {
            background-color: var(--primary-color);
            color: var(--white-color);
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            line-height: 1;
        }

        /* Секции (Виды) */
        .view {
             /* display: none; */ /* Managed by active/transition classes now */
            flex-direction: column;
            width: 100%;
            background-color: var(--white-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            flex-grow: 1;
            /* Animation / Transition properties */
            opacity: 0;
            transform: translateX(100%);
            transition: opacity var(--transition-speed) ease-out, transform var(--transition-speed) ease-out;
            position: absolute; /* Needed for transition */
            top: 0;
            left: 0;
            visibility: hidden; /* Hide inactive views completely */
             display: flex; /* Keep flex for layout even when hidden */
         }

         .view.active {
            opacity: 1;
            transform: translateX(0);
            position: relative; /* Bring active view back into flow */
            z-index: 10; /* Ensure active view is on top */
            visibility: visible;
         }

         .view.exiting { /* Class for view that is leaving */
             transform: translateX(-100%);
             z-index: 5;
             opacity: 0;
         }


        h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        /* Меню: Контролы */
         #menu-controls {
             border-bottom: 1px solid var(--accent-color);
             padding-bottom: 15px;
             margin-bottom: 20px;
             display: flex;
             flex-wrap: wrap;
             gap: 15px; /* Increased gap */
             align-items: center;
         }
         #category-filters {
            display: flex;
            gap: 8px;
            flex-grow: 1;
            flex-wrap: wrap; /* Allow filters to wrap on small screens */
         }
         .btn-filter {
             padding: 6px 15px;
             border: 1px solid var(--primary-color);
             background-color: transparent;
             color: var(--primary-color);
             border-radius: 20px;
             cursor: pointer;
             transition: all var(--transition-speed-fast) ease;
             font-size: 0.9em;
             flex-shrink: 0;
         }
         .btn-filter.active, .btn-filter:hover {
             background-color: var(--primary-color);
             color: var(--white-color);
             transform: scale(1.03);
         }
         #menu-search {
             padding: 8px 12px;
             border: 1px solid #ddd;
             border-radius: 20px;
             font-size: 0.9em;
             min-width: 150px;
             transition: border-color var(--transition-speed-fast) ease;
         }
         #menu-search:focus {
             outline: none;
             border-color: var(--primary-color);
         }

        /* Меню: Сетка */
        #menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        .menu-item {
            background-color: #fff;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: transform var(--transition-speed-fast) ease, box-shadow var(--transition-speed-fast) ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
            border: 1px solid #eee;
            position: relative; /* For disabled overlay */
        }
        .menu-item:hover:not(.disabled) {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 15px rgba(111, 78, 55, 0.2);
        }
        .menu-item img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
            margin-bottom: 10px;
            border-radius: calc(var(--border-radius) - 5px);
        }
        .menu-item h3 {
            font-size: 1em;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        .menu-item .price {
            font-size: 0.9em;
            font-weight: bold;
            color: var(--text-color);
        }
        /* Disabled state for menu items */
        .menu-item.disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .menu-item.disabled::after {
            content: 'Нет';
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
        }


        /* Кастомизация */
        .customization-option {
            margin-bottom: 20px;
            transition: opacity 0.3s ease, max-height 0.4s ease; /* Animation */
            overflow: hidden; /* Needed for max-height transition */
        }
        /* Hide options smoothly */
        .customization-option:not(.visible) {
             opacity: 0;
             max-height: 0;
             margin-bottom: 0;
             overflow: hidden;
             padding: 0;
             border: none;
        }
         .customization-option.visible {
             opacity: 1;
             max-height: 500px; /* Adjust if needed */
         }

        .customization-option h4 { /* Styles from before */ }
        .option-group { /* Styles from before */ }
        .option-group label { /* Styles from before */ }
        .option-group input[type="radio"] { /* Styles from before */ }
        .option-group input[type="radio"]:checked + label { /* Styles from before */ }
         /* Disabled state for options */
         .option-group input[type="radio"]:disabled + label {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: var(--disabled-color);
            border-color: #bbb;
            color: #777;
         }
         .option-group input[type="radio"]:disabled:checked + label {
            background-color: #a0a0a0; /* Darker grey when checked but disabled */
         }


        #current-item-price { /* Styles from before */ }

        /* Корзина / Заказ */
        #order-items-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }
        #order-items-list li {
            background-color: var(--secondary-color);
            padding: 10px 12px; /* Adjusted padding */
            margin-bottom: 10px;
            border-radius: var(--border-radius-small);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap; /* Prevent wrapping for controls */
            border-left: 5px solid var(--accent-color);
            transition: background-color 0.3s ease, opacity 0.4s ease, transform 0.4s ease;
            overflow: hidden; /* Clip content during animation */
        }
        /* Анимация добавления/удаления */
        #order-items-list li.item-entering {
            opacity: 0;
            transform: translateX(-20px);
        }
        #order-items-list li.item-leaving {
            opacity: 0;
            transform: scale(0.9);
            background-color: #ffdddd;
        }

        #order-items-list li .item-details {
            flex-grow: 1;
            margin-right: 10px;
            overflow: hidden; /* Prevent long names breaking layout */
            white-space: nowrap; /* Keep name on one line */
            text-overflow: ellipsis; /* Add ... for long names */
        }
        #order-items-list li .item-name {
            font-weight: bold;
            color: var(--primary-color);
            display: block;
             white-space: nowrap;
             text-overflow: ellipsis;
             overflow: hidden;
        }
        #order-items-list li .item-customizations {
            font-size: 0.8em; /* Slightly smaller */
            color: #555;
            display: block;
            margin-top: 2px;
             white-space: nowrap;
             text-overflow: ellipsis;
             overflow: hidden;
        }
         /* Controls container */
         #order-items-list li .item-controls {
             display: flex;
             align-items: center;
             gap: 8px; /* Gap between control groups */
             margin-left: auto; /* Push to right */
             flex-shrink: 0; /* Prevent shrinking */
         }
         .quantity-controls {
             display: flex;
             align-items: center;
             gap: 5px;
             white-space: nowrap;
         }
         .quantity-controls .btn-quantity {
             background-color: var(--accent-color);
             color: white;
             border: none;
             border-radius: 50%;
             width: 22px;
             height: 22px;
             font-size: 14px;
             line-height: 20px; /* Adjusted for centering */
             text-align: center;
             cursor: pointer;
             transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
             padding: 0;
             display: flex; /* Center content */
             justify-content: center; /* Center content */
             align-items: center; /* Center content */
         }
         .quantity-controls .btn-quantity:hover {
             background-color: #c89053;
             transform: scale(1.1);
         }
         .quantity-controls .item-quantity {
             font-weight: bold;
             min-width: 20px;
             text-align: center;
             font-size: 0.95em;
         }
         .item-price { /* Price shown in cart controls */
             font-weight: bold;
             white-space: nowrap;
             font-size: 0.95em;
             min-width: 50px; /* Ensure some space */
             text-align: right;
         }
         .btn-edit-item {
             background: none;
             border: none;
             font-size: 1.1em; /* Slightly smaller */
             cursor: pointer;
             color: var(--primary-color);
             padding: 0 3px; /* Reduced padding */
             transition: transform var(--transition-speed-fast) ease;
             line-height: 1;
         }
         .btn-edit-item:hover {
             transform: scale(1.15);
         }
         .btn-remove-item { /* Styles mostly from before */
             background: #ff4d4d;
             color: white;
             border: none;
             border-radius: 50%;
             width: 22px; /* Matched quantity buttons */
             height: 22px;
             font-size: 14px;
             cursor: pointer;
             line-height: 22px; /* Adjusted */
             text-align: center;
             padding: 0;
             flex-shrink: 0;
             transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
         }
         .btn-remove-item:hover {
             background-color: #e60000;
             transform: scale(1.1);
         }


        #order-total { /* Styles from before */ }
        #qr-code-container { /* Styles from before */ }
        #qr-code { /* Styles from before */ }
        #qr-code img { /* Styles from before */ }
        #order-status-container { /* Styles from before */ }
        #order-status-container h4 { /* Styles from before */ }
        #order-status { /* Styles from before */ }
        .status-pending, .status-processing, .status-ready { /* Styles from before */ }

        /* Кнопки */
        .button-group { /* Styles from before */ }
        .btn { /* Styles from before */ }
        /* Individual button styles (.btn-primary etc) - Styles from before */

        /* Анимации */
        @keyframes fadeIn { /* Styles from before */ }
        @keyframes slideDown { /* Styles from before */ }
        @keyframes spin { /* Styles from before */ }

        /* Индикатор загрузки */
        .loader { /* Styles from before */ }

        /* Пустой заказ */
        #empty-order-message { /* Styles from before */ }

        /* Временные сообщения */
        .temp-message { /* Styles from before */ }
        .temp-message.success { /* Styles from before */ }
        .temp-message.error { /* Styles from before */ }
        .temp-message.info { /* Styles from before */ }
        .temp-message.show { /* Styles from before */ }

        /* Footer */
        footer { /* Styles from before */ }

    </style>
</head>
<body>

    <header>
        <h1>Уютное Кофе v2</h1>
        <button id="go-to-cart-btn" class="btn-cart">🛒 <span id="cart-count">0</span></button>
    </header>

    <div class="container">

        <section id="menu-view" class="view active">
            <h2>Меню</h2>
            <div id="menu-controls">
                <div id="category-filters">
                    <button class="btn btn-filter active" data-category="all">Все</button>
                    <button class="btn btn-filter" data-category="coffee">Кофе</button>
                    <button class="btn btn-filter" data-category="dessert">Десерты</button>
                </div>
                <input type="search" id="menu-search" placeholder="Поиск по названию...">
            </div>
            <div id="menu-grid">
                <p>Загрузка меню...</p>
            </div>
        </section>

        <section id="customization-view" class="view">
            <h2 id="customization-item-name">Настройте ваш напиток</h2>

            <div class="customization-option visible" id="volume-option-section">
                 <h4>Объём</h4>
                 <div class="option-group" id="volume-options">
                     <input type="radio" id="volume-small" name="volume" value="Маленький" data-multiplier="1.0" checked>
                     <label for="volume-small">Маленький (S)</label>
                     <input type="radio" id="volume-medium" name="volume" value="Средний" data-multiplier="1.2">
                     <label for="volume-medium">Средний (M)</label>
                     <input type="radio" id="volume-large" name="volume" value="Большой" data-multiplier="1.5">
                     <label for="volume-large">Большой (L)</label>
                 </div>
             </div>

            <div class="customization-option visible" id="sweetness-option-section">
                <h4>Сладость</h4>
                <div class="option-group" id="sweetness-options">
                    <input type="radio" id="sweet-none" name="sweetness" value="Без сахара" data-price-mod="0" checked>
                    <label for="sweet-none">Без сахара</label>
                    <input type="radio" id="sweet-low" name="sweetness" value="Немного" data-price-mod="10">
                    <label for="sweet-low">Немного (+10₸)</label>
                    <input type="radio" id="sweet-standard" name="sweetness" value="Стандарт" data-price-mod="20">
                    <label for="sweet-standard">Стандарт (+20₸)</label>
                    <input type="radio" id="sweet-high" name="sweetness" value="Сладкий" data-price-mod="30">
                    <label for="sweet-high">Сладкий (+30₸)</label>
                </div>
            </div>

            <div class="customization-option visible" id="strength-option-section">
                <h4>Крепость</h4>
                <div class="option-group" id="strength-options">
                    <input type="radio" id="strength-standard" name="strength" value="Стандарт" checked>
                    <label for="strength-standard">Стандарт</label>
                    <input type="radio" id="strength-high" name="strength" value="Крепче">
                    <label for="strength-high">Крепче</label>
                </div>
            </div>

            <div class="customization-option" id="milk-option-section"> <h4>Тип молока</h4>
                <div class="option-group" id="milk-options">
                    <p>Загрузка опций молока...</p>
                </div>
            </div>

            <div class="customization-option" id="syrup-option-section"> <h4>Сироп</h4>
                <div class="option-group" id="syrup-options">
                     <p>Загрузка опций сиропа...</p>
                </div>
            </div>

            <div id="current-item-price">Цена: 0₸</div>
            <div class="button-group">
                 <button id="back-to-menu-btn" class="btn btn-back">Назад к меню</button>
                 <button id="add-update-order-btn" class="btn btn-primary">Добавить в заказ</button>
            </div>
        </section>

        <section id="order-view" class="view">
            <h2>Ваш заказ</h2>
            <div id="order-content">
                 <ul id="order-items-list">
                     </ul>
                 <div id="order-total">Общая сумма: 0₸</div>
            </div>
            <p id="empty-order-message" style="display: none;">Ваш заказ пока пуст. Добавьте что-нибудь из меню!</p>
            <div id="qr-and-status" style="display: none;">
                <div id="qr-code-container">
                    <h4>Ваш QR-код для получения заказа</h4>
                    <div id="qr-code"></div>
                </div>
                <div id="order-status-container">
                    <h4>Статус приготовления</h4>
                    <div id="order-status">Ожидание...</div>
                    <div id="status-loader" class="loader" style="display: none;"></div>
                </div>
            </div>
            <div class="button-group">
                <button id="clear-order-btn" class="btn btn-back">Очистить заказ</button>
                <button id="checkout-btn" class="btn btn-confirm">Оформить заказ</button>
                <button id="new-order-btn" class="btn btn-secondary" style="display: none;">Сделать новый заказ</button>
            </div>
        </section>

    </div>

    <footer>
        © 2025 Уютное Кофе v2. Приятного аппетита!
    </footer>

    <script>
        // --- Данные Меню и Кастомизации ---
        const menuData = [
            // Кофе (кастомизируемый)
            { id: 'espresso', name: 'Эспрессо', basePrice: 500, image: 'https://images.unsplash.com/photo-1511920170033-f8396924c348?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'coffee', customizable: true, options: ['strength'] },
            { id: 'cappuccino', name: 'Капучино', basePrice: 700, image: 'https://images.unsplash.com/photo-1557006094-40e596d98303?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'coffee', customizable: true, options: ['volume', 'sweetness', 'strength', 'milk', 'syrup'] },
            { id: 'latte', name: 'Латте', basePrice: 750, image: 'https://images.unsplash.com/photo-1561882468-91101f2L_ZyQ?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'coffee', customizable: true, options: ['volume', 'sweetness', 'strength', 'milk', 'syrup'] },
            { id: 'americano', name: 'Американо', basePrice: 600, image: 'https://images.unsplash.com/photo-1580933075516-ac7f7767164a?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'coffee', customizable: true, options: ['volume', 'strength'] },
            { id: 'mocha', name: 'Мокко', basePrice: 850, image: 'https://images.unsplash.com/photo-1608079778818-a04d8e4b2e4f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'coffee', customizable: true, options: ['volume', 'sweetness', 'strength', 'milk'] },
            { id: 'raf', name: 'Раф', basePrice: 900, image: 'https://images.unsplash.com/photo-1572498859711-ff8e018124c8?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'coffee', customizable: true, options: ['volume', 'strength', 'syrup'] },
            // Десерты (не кастомизируемые)
            { id: 'croissant', name: 'Круассан', basePrice: 450, image: 'https://images.unsplash.com/photo-1587132137056-7a8f0165f7d5?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'dessert', customizable: false, options: [] },
            { id: 'cheesecake', name: 'Чизкейк', basePrice: 800, image: 'https://images.unsplash.com/photo-1543572858-ab24314cd5cc?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'dessert', customizable: false, options: [] },
            { id: 'muffin', name: 'Маффин', basePrice: 550, image: 'https://images.unsplash.com/photo-1615310749319-39a1a5911043?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=300&q=80', category: 'dessert', customizable: false, options: [] },
        ];
        const customizationData = {
            volume: [ // Добавим сюда для единообразия
                { id: 'volume-small', name: 'Маленький', multiplier: 1.0, default: true },
                { id: 'volume-medium', name: 'Средний', multiplier: 1.2 },
                { id: 'volume-large', name: 'Большой', multiplier: 1.5 },
            ],
             sweetness: [
                 { id: 'sweet-none', name: 'Без сахара', priceMod: 0, default: true },
                 { id: 'sweet-low', name: 'Немного', priceMod: 10 },
                 { id: 'sweet-standard', name: 'Стандарт', priceMod: 20 },
                 { id: 'sweet-high', name: 'Сладкий', priceMod: 30 },
             ],
             strength: [
                 { id: 'strength-standard', name: 'Стандарт', default: true },
                 { id: 'strength-high', name: 'Крепче' },
             ],
             milk: [
                 { id: 'milk-standard', name: 'Обычное', priceMod: 0, default: true },
                 { id: 'milk-skim', name: 'Обезжиренное', priceMod: 0 },
                 { id: 'milk-almond', name: 'Миндальное', priceMod: 150 },
                 { id: 'milk-soy', name: 'Соевое', priceMod: 100 },
             ],
             syrup: [
                 { id: 'syrup-none', name: 'Без сиропа', priceMod: 0, default: true },
                 { id: 'syrup-vanilla', name: 'Ванильный', priceMod: 100 },
                 { id: 'syrup-caramel', name: 'Карамельный', priceMod: 100 },
                 { id: 'syrup-hazelnut', name: 'Ореховый', priceMod: 120 },
             ]
         };

        // --- Состояние Приложения ---
        let currentViewId = 'menu-view';
        let previousViewId = null;
        let selectedItem = null; // Текущий выбранный элемент меню (копия из menuData)
        let currentOrder = []; // Массив с элементами заказа
        let editingOrderItemId = null; // ID элемента заказа для редактирования
        // Фильтры
        let currentFilterCategory = 'all';
        let currentSearchTerm = '';
        const LOCAL_STORAGE_KEY = 'coffeeShopOrder_v2';

        // --- DOM Элементы ---
        const views = { // Собираем все виды для легкого доступа
             'menu-view': document.getElementById('menu-view'),
             'customization-view': document.getElementById('customization-view'),
             'order-view': document.getElementById('order-view')
        };
        const menuGrid = document.getElementById('menu-grid');
        const categoryFiltersContainer = document.getElementById('category-filters');
        const menuSearchInput = document.getElementById('menu-search');
        // Кастомизация
        const customizationItemName = document.getElementById('customization-item-name');
        const currentItemPriceDisplay = document.getElementById('current-item-price');
        const customizationOptionsContainers = { // Контейнеры для групп опций
            volume: document.getElementById('volume-options'),
            sweetness: document.getElementById('sweetness-options'),
            strength: document.getElementById('strength-options'),
            milk: document.getElementById('milk-options'),
            syrup: document.getElementById('syrup-options'),
        };
        const customizationOptionSections = { // Секции для скрытия/показа
            volume: document.getElementById('volume-option-section'),
            sweetness: document.getElementById('sweetness-option-section'),
            strength: document.getElementById('strength-option-section'),
            milk: document.getElementById('milk-option-section'),
            syrup: document.getElementById('syrup-option-section'),
        };
        // Заказ
        const orderItemsList = document.getElementById('order-items-list');
        const orderTotalDisplay = document.getElementById('order-total');
        const qrCodeContainer = document.getElementById('qr-code');
        const orderStatusDisplay = document.getElementById('order-status');
        const statusLoader = document.getElementById('status-loader');
        const qrAndStatusSection = document.getElementById('qr-and-status');
        const orderContent = document.getElementById('order-content');
        const emptyOrderMessage = document.getElementById('empty-order-message');
        const cartCountSpan = document.getElementById('cart-count');

        // Кнопки
        const goToCartBtn = document.getElementById('go-to-cart-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const addUpdateOrderBtn = document.getElementById('add-update-order-btn'); // Переименована
        const clearOrderBtn = document.getElementById('clear-order-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        const newOrderBtn = document.getElementById('new-order-btn');

        // --- Helper Функции ---

        // Сохранение в localStorage
        function saveOrderToLocalStorage() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentOrder));
            } catch (e) {
                console.error("Ошибка сохранения заказа в localStorage:", e);
                showTemporaryMessage("Не удалось сохранить заказ", "error");
            }
        }

        // Загрузка из localStorage
        function loadOrderFromLocalStorage() {
            try {
                const savedOrder = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (savedOrder) {
                    currentOrder = JSON.parse(savedOrder);
                    // Убедимся, что quantity - число
                    currentOrder.forEach(item => item.quantity = parseInt(item.quantity) || 1);
                } else {
                    currentOrder = [];
                }
            } catch (e) {
                console.error("Ошибка загрузки заказа из localStorage:", e);
                currentOrder = [];
                localStorage.removeItem(LOCAL_STORAGE_KEY); // Очистить некорректные данные
            }
        }

        // Показать временное сообщение (из прошлой версии)
         function showTemporaryMessage(message, type = "info") {
            const msgDiv = document.createElement('div');
            msgDiv.textContent = message;
            msgDiv.className = `temp-message ${type}`;
            document.body.appendChild(msgDiv);
            setTimeout(() => { msgDiv.classList.add('show'); }, 10);
            setTimeout(() => {
                msgDiv.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(msgDiv)) { document.body.removeChild(msgDiv); }
                }, 500);
            }, 2500);
         }

        // Генерация HTML для опций кастомизации
        function generateOptionsHTML(optionType, availableOptionsData, selectedValueId = null) {
            const container = customizationOptionsContainers[optionType];
            if (!container) return ''; // Если контейнер не найден

            container.innerHTML = ''; // Очистка
            let html = '';
            let defaultChecked = false;

            availableOptionsData.forEach(option => {
                // Определяем, должна ли эта опция быть выбрана
                 // 1. Если редактируем и это значение выбрано у редактируемого элемента
                 // 2. Если НЕ редактируем и это опция по умолчанию (и еще ни одна не выбрана по умолчанию)
                 // 3. Если НЕ редактируем, нет опции по умолчанию, и это первая опция в списке
                 const isChecked = selectedValueId ? option.id === selectedValueId : (option.default && !defaultChecked);


                 html += `
                    <input type="radio"
                           id="${option.id}"
                           name="${optionType}"
                           value="${option.id}"
                           ${option.priceMod !== undefined ? `data-price-mod="${option.priceMod}"` : ''}
                           ${option.multiplier !== undefined ? `data-multiplier="${option.multiplier}"` : ''}
                           ${isChecked ? 'checked' : ''}
                           >
                     <label for="${option.id}">${option.name}${option.priceMod > 0 ? ` (+${option.priceMod}₸)` : ''}</label>
                 `;
                 if (isChecked) defaultChecked = true; // Отмечаем, что нашли выбранную по умолчанию
             });

             // Если ни одна опция не была выбрана по умолчанию (например, из-за редактирования несуществующего значения),
             // выбираем первую опцию принудительно.
             if (!defaultChecked && availableOptionsData.length > 0) {
                 html = html.replace(`id="${availableOptionsData[0].id}"`, `id="${availableOptionsData[0].id}" checked`);
             }

             container.innerHTML = html; // Вставляем сгенерированный HTML
         }

         // Генерация ключа для уникальной кастомизации
         function getCustomizationKey(customizations) {
             // Сортируем ключи, чтобы порядок не влиял
             return Object.keys(customizations).sort().map(key => `${key}:${customizations[key]}`).join('|');
         }

         // Генерация строки кастомизации для отображения в корзине
         function getCustomizationString(customizations) {
             let parts = [];
             // Используем данные из customizationData для получения имен
             for (const key in customizations) {
                 if (customizationData[key]) {
                    const selectedOptionData = customizationData[key].find(opt => opt.id === customizations[key]);
                    if (selectedOptionData && !selectedOptionData.default) { // Показываем только НЕ дефолтные опции
                        parts.push(selectedOptionData.name);
                    } else if (!customizationData[key] && customizations[key]) {
                        // Fallback for keys not in customizationData (shouldn't happen with current setup)
                        parts.push(customizations[key]);
                    }
                 }
             }
            // Если нет НЕ дефолтных опций, но товар кастомизируемый, покажем хотя бы объем или "Стандарт"
             if (parts.length === 0 && customizations.volume) {
                const volData = customizationData.volume.find(opt => opt.id === customizations.volume);
                 if(volData) parts.push(volData.name);
             }
             if (parts.length === 0) return "Стандарт"; // Если совсем ничего нет

             return parts.join(', ');
         }


         // --- Основные Функции ---

         // Показать нужный вид (с анимацией)
        function showView(viewIdToShow) {
            if (currentViewId === viewIdToShow) return; // Не переключаться на тот же вид

            const currentViewElement = views[currentViewId];
            const nextViewElement = views[viewIdToShow];

            if (!nextViewElement) {
                console.error("View ID not found:", viewIdToShow);
                return;
            }

            previousViewId = currentViewId; // Запомнить предыдущий вид

            if (currentViewElement) {
                currentViewElement.classList.add('exiting'); // Начать анимацию ухода
            }

            // Установить новый вид как активный *до* удаления exiting у старого,
            // чтобы избежать мерцания фона
             nextViewElement.classList.remove('exiting'); // Убрать на всякий случай
             nextViewElement.classList.add('active');
             currentViewId = viewIdToShow;


            // После завершения анимации ухода старого вида, убрать его из DOM-потока (или скрыть)
             if (currentViewElement) {
                 // Используем setTimeout, чтобы дождаться завершения transition
                 setTimeout(() => {
                     currentViewElement.classList.remove('active');
                     currentViewElement.classList.remove('exiting');
                 }, parseFloat(getComputedStyle(currentViewElement).transitionDuration) * 1000);
             }


            window.scrollTo(0, 0); // Прокрутка вверх

            // Обновление кнопок ТОЛЬКО если перешли в корзину
            if (currentViewId === 'order-view') {
                updateOrderViewButtons();
            } else {
                 // Сброс специфичных для корзины состояний, если мы НЕ в корзине
                 newOrderBtn.style.display = 'none';
            }
        }


        // Рендер меню (с фильтрацией и поиском)
        function renderMenu() {
            menuGrid.innerHTML = ''; // Очистка

            // 1. Фильтрация по категории
            let filteredItems = menuData;
            if (currentFilterCategory !== 'all') {
                filteredItems = menuData.filter(item => item.category === currentFilterCategory);
            }

            // 2. Фильтрация по поиску
            const searchTerm = currentSearchTerm.toLowerCase().trim();
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => item.name.toLowerCase().includes(searchTerm));
            }

            // 3. Рендеринг
            if (filteredItems.length === 0) {
                menuGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #777;">Ничего не найдено.</p>';
                return;
            }

            filteredItems.forEach(item => {
                const div = document.createElement('div');
                div.classList.add('menu-item');
                div.dataset.itemId = item.id;
                // TODO: Добавить проверку inStock и класс disabled
                // div.classList.toggle('disabled', !item.inStock);

                div.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" loading="lazy">
                    <div>
                         <h3>${item.name}</h3>
                         <span class="price">${item.basePrice}₸</span>
                    </div>
                `;

                // Добавляем обработчик клика
                 // if (item.inStock) { // Только если в наличии
                     div.addEventListener('click', () => {
                        if(item.customizable) {
                             handleMenuItemClick(item.id);
                        } else {
                             // Для некастомизируемых товаров (десерты) - сразу в корзину
                             addNonCustomizableItem(item.id);
                        }
                    });
                 // }

                menuGrid.appendChild(div);
            });
        }

         // Добавление некастомизируемого товара
         function addNonCustomizableItem(itemId) {
             const itemData = menuData.find(i => i.id === itemId);
             if (!itemData) return;

             const customizationKey = 'non-customizable'; // Уникальный ключ для таких товаров
             const existingItem = currentOrder.find(orderItem => orderItem.id === itemId && orderItem.customizationKey === customizationKey);

             if (existingItem) {
                 existingItem.quantity++;
             } else {
                 const orderItem = {
                     orderItemId: `item-${Date.now()}-${Math.random().toString(16).slice(2)}`, // Уникальный ID
                     id: itemData.id,
                     name: itemData.name,
                     price: itemData.basePrice,
                     quantity: 1,
                     customizations: {}, // Пустой объект
                     customizationKey: customizationKey,
                     customizationString: '' // Пустая строка
                 };
                 currentOrder.push(orderItem);
                 // Анимация добавления в корзине (если она открыта)
                 setTimeout(() => { // Дать время на ререндер, если корзина уже открыта
                     const liElement = orderItemsList.querySelector(`li[data-order-item-id="${orderItem.orderItemId}"]`);
                     if(liElement) {
                        liElement.classList.add('item-entering');
                        setTimeout(() => liElement.classList.remove('item-entering'), 10); // Начать анимацию
                     }
                 }, 0);
             }
             updateOrderSummary();
             saveOrderToLocalStorage();
             showTemporaryMessage(`${itemData.name} добавлен в корзину`, "success");
         }


        // Клик по кастомизируемому товару в меню
        function handleMenuItemClick(itemId) {
            const item = menuData.find(i => i.id === itemId);
            if (!item || !item.customizable) return;

            selectedItem = { ...item }; // Копируем
            editingOrderItemId = null; // Сбрасываем режим редактирования
            addUpdateOrderBtn.textContent = "Добавить в заказ"; // Сброс текста кнопки

            // Показываем/скрываем секции опций и генерируем их HTML
            Object.keys(customizationOptionSections).forEach(optionType => {
                const section = customizationOptionSections[optionType];
                const container = customizationOptionsContainers[optionType];
                const isAvailable = selectedItem.options.includes(optionType);

                section.classList.toggle('visible', isAvailable);

                if (isAvailable && container && customizationData[optionType]) {
                     generateOptionsHTML(optionType, customizationData[optionType]); // Генерируем с дефолтными значениями
                } else if (container) {
                    container.innerHTML = ''; // Очищаем контейнер, если опция недоступна
                }
            });

            customizationItemName.textContent = `Настройте: ${selectedItem.name}`;
            updateCustomizationPrice(); // Показываем цену с дефолтными опциями
            showView('customization-view');
        }

        // Обновление цены в окне кастомизации
        function updateCustomizationPrice() {
            if (!selectedItem) return;

            let currentPrice = selectedItem.basePrice;
            let volumeMultiplier = 1.0;

            // Проходим по всем типам опций, которые есть в DOM
            Object.keys(customizationOptionsContainers).forEach(optionType => {
                const container = customizationOptionsContainers[optionType];
                const selectedRadio = container.querySelector(`input[name="${optionType}"]:checked`);

                if (selectedRadio) {
                    const priceMod = parseInt(selectedRadio.dataset.priceMod) || 0;
                    const multiplier = parseFloat(selectedRadio.dataset.multiplier) || null;

                    currentPrice += priceMod;
                    if (multiplier !== null) {
                        volumeMultiplier = multiplier;
                    }
                }
            });

            // Применяем множитель объема ПОСЛЕ добавления модификаторов цены
            currentPrice = Math.round(selectedItem.basePrice * volumeMultiplier) + (currentPrice - selectedItem.basePrice);

            currentItemPriceDisplay.textContent = `Цена: ${currentPrice}₸`;
            return currentPrice; // Возвращаем для использования в других функциях
        }

        // Клик по кнопке "Добавить в заказ" / "Обновить позицию"
        function handleAddUpdateItem() {
            if (!selectedItem && !editingOrderItemId) return; // Должен быть выбран товар или режим редактирования

            // Собираем выбранные кастомизации
            const currentCustomizations = {};
            const itemOptions = selectedItem ? selectedItem.options : // Если добавляем новый
                                 currentOrder.find(i => i.orderItemId === editingOrderItemId)?.options || []; // Если редактируем (нужно добавить options в orderItem?)
                                                                                                       // Проще взять из menuData по id редактируемого итема
            const originalItemData = menuData.find(m => m.id === (selectedItem?.id || currentOrder.find(i => i.orderItemId === editingOrderItemId)?.id));
            const availableOptions = originalItemData?.options || Object.keys(customizationOptionsContainers); // Все опции по умолчанию, если не указано

            availableOptions.forEach(optionType => {
                const container = customizationOptionsContainers[optionType];
                const selectedRadio = container.querySelector(`input[name="${optionType}"]:checked`);
                if (selectedRadio) {
                    currentCustomizations[optionType] = selectedRadio.value;
                }
                // Если опции нет в DOM (скрыта), но она есть в customizationData, добавим дефолтное значение
                else if(customizationData[optionType] && !customizationOptionSections[optionType].classList.contains('visible')) {
                    const defaultOption = customizationData[optionType].find(opt => opt.default);
                    if(defaultOption) {
                        currentCustomizations[optionType] = defaultOption.id;
                    }
                }
            });

             const finalPrice = updateCustomizationPrice(); // Получаем итоговую цену
             const customizationKey = getCustomizationKey(currentCustomizations);
             const customizationString = getCustomizationString(currentCustomizations);

             if (editingOrderItemId) {
                // --- Режим Обновления ---
                const itemToUpdate = currentOrder.find(item => item.orderItemId === editingOrderItemId);
                if (itemToUpdate) {
                    itemToUpdate.price = finalPrice; // Обновляем цену за единицу
                    itemToUpdate.customizations = currentCustomizations;
                    itemToUpdate.customizationKey = customizationKey;
                    itemToUpdate.customizationString = customizationString;
                    // Quantity не меняем при редактировании, только настройки
                }
                 editingOrderItemId = null; // Выход из режима редактирования
                 addUpdateOrderBtn.textContent = "Добавить в заказ"; // Возвращаем текст кнопки
                 saveOrderToLocalStorage();
                 updateOrderSummary();
                 showView('order-view'); // Возвращаемся в корзину
                 showTemporaryMessage("Позиция обновлена", "success");

             } else if (selectedItem) {
                 // --- Режим Добавления ---
                 const existingItem = currentOrder.find(orderItem =>
                    orderItem.id === selectedItem.id && orderItem.customizationKey === customizationKey
                 );

                 if (existingItem) {
                     // Увеличиваем количество существующего
                     existingItem.quantity++;
                 } else {
                     // Добавляем новый элемент
                     const orderItem = {
                         orderItemId: `item-${Date.now()}-${Math.random().toString(16).slice(2)}`,
                         id: selectedItem.id,
                         name: selectedItem.name,
                         price: finalPrice, // Цена за 1 шт
                         quantity: 1,
                         customizations: currentCustomizations,
                         customizationKey: customizationKey,
                         customizationString: customizationString
                     };
                     currentOrder.push(orderItem);
                     // Анимация добавления (только для нового элемента)
                     setTimeout(() => {
                        const liElement = orderItemsList.querySelector(`li[data-order-item-id="${orderItem.orderItemId}"]`);
                         if(liElement) {
                             liElement.classList.add('item-entering');
                             setTimeout(() => liElement.classList.remove('item-entering'), 10);
                         }
                     }, 0);

                 }
                 saveOrderToLocalStorage();
                 updateOrderSummary();
                 showView('menu-view'); // Возвращаемся в меню
                 showTemporaryMessage(`${selectedItem.name} добавлен в корзину`, "success");
                 selectedItem = null; // Сбрасываем выбранный итем
             }
        }


        // Обновление отображения корзины
        function updateOrderSummary() {
            orderItemsList.innerHTML = ''; // Очистка
            let total = 0;

            if (currentOrder.length === 0) {
                 orderContent.style.display = 'none';
                 emptyOrderMessage.style.display = 'block';
            } else {
                 orderContent.style.display = 'block';
                 emptyOrderMessage.style.display = 'none';

                 currentOrder.forEach(item => {
                     const li = document.createElement('li');
                     li.dataset.orderItemId = item.orderItemId; // Устанавливаем ID

                     li.innerHTML = `
                        <div class="item-details">
                            <span class="item-name">${item.name}</span>
                            ${item.customizationString ? `<span class="item-customizations">${item.customizationString}</span>` : ''}
                        </div>
                        <div class="item-controls">
                             <div class="quantity-controls">
                                 <button class="btn-quantity btn-decrease" data-id="${item.orderItemId}" title="Уменьшить">-</button>
                                 <span class="item-quantity">${item.quantity}</span>
                                 <button class="btn-quantity btn-increase" data-id="${item.orderItemId}" title="Увеличить">+</button>
                             </div>
                             <span class="item-price">${item.price * item.quantity}₸</span>
                             ${menuData.find(m => m.id === item.id)?.customizable ? // Кнопка Edit только для кастомизируемых
                                `<button class="btn-edit-item" data-id="${item.orderItemId}" title="Изменить">✏️</button>` :
                                '<span style="width: 24px; display: inline-block;"></span>' // Пустышка для выравнивания
                             }
                             <button class="btn-remove-item" data-id="${item.orderItemId}" title="Удалить позицию">×</button>
                        </div>
                    `;
                     orderItemsList.appendChild(li);
                     total += item.price * item.quantity;
                 });

                 // Добавляем обработчики событий один раз после рендеринга
                 attachCartItemListeners();
             }

            orderTotalDisplay.textContent = `Общая сумма: ${total}₸`;
            cartCountSpan.textContent = currentOrder.reduce((sum, item) => sum + item.quantity, 0); // Суммируем количество

            // Обновляем кнопки, если мы в корзине
            if (currentViewId === 'order-view') {
                updateOrderViewButtons();
            }
        }

        // Установка обработчиков на элементы корзины
        function attachCartItemListeners() {
            orderItemsList.querySelectorAll('.btn-decrease').forEach(btn => {
                btn.addEventListener('click', () => decreaseQuantity(btn.dataset.id));
            });
            orderItemsList.querySelectorAll('.btn-increase').forEach(btn => {
                btn.addEventListener('click', () => increaseQuantity(btn.dataset.id));
            });
            orderItemsList.querySelectorAll('.btn-edit-item').forEach(btn => {
                btn.addEventListener('click', () => handleEditItem(btn.dataset.id));
            });
            orderItemsList.querySelectorAll('.btn-remove-item').forEach(btn => {
                btn.addEventListener('click', () => removeItemFromOrder(btn.dataset.id));
            });
        }


        // Увеличение количества
        function increaseQuantity(orderItemId) {
            const item = currentOrder.find(i => i.orderItemId === orderItemId);
            if (item) {
                item.quantity++;
                saveOrderToLocalStorage();
                updateOrderSummary(); // Перерисовать корзину
            }
        }

        // Уменьшение количества
        function decreaseQuantity(orderItemId) {
            const item = currentOrder.find(i => i.orderItemId === orderItemId);
            if (item) {
                item.quantity--;
                if (item.quantity <= 0) {
                    removeItemFromOrder(orderItemId); // Удалить, если 0
                } else {
                    saveOrderToLocalStorage();
                    updateOrderSummary(); // Перерисовать корзину
                }
            }
        }

        // Удаление элемента из заказа
        function removeItemFromOrder(orderItemIdToRemove) {
            const itemIndex = currentOrder.findIndex(item => item.orderItemId === orderItemIdToRemove);
            if (itemIndex > -1) {
                const liElement = orderItemsList.querySelector(`li[data-order-item-id="${orderItemIdToRemove}"]`);
                if(liElement) { // Анимация удаления
                    liElement.classList.add('item-leaving');
                    // Удаляем из массива и localStorage ПОСЛЕ анимации
                     setTimeout(() => {
                         currentOrder.splice(itemIndex, 1);
                         saveOrderToLocalStorage();
                         updateOrderSummary(); // Перерисовать без удаленного элемента
                         showTemporaryMessage("Позиция удалена", "info");
                    }, 400); // Должно совпадать с transition-duration
                } else {
                    // Если элемента нет в DOM (редко), удаляем сразу
                     currentOrder.splice(itemIndex, 1);
                     saveOrderToLocalStorage();
                     updateOrderSummary();
                     showTemporaryMessage("Позиция удалена", "info");
                }


            }
        }


        // Клик по кнопке "Изменить" в корзине
        function handleEditItem(orderItemId) {
            const itemToEdit = currentOrder.find(item => item.orderItemId === orderItemId);
            if (!itemToEdit) return;

            const originalMenuItem = menuData.find(m => m.id === itemToEdit.id);
            if (!originalMenuItem || !originalMenuItem.customizable) return; // Нельзя редактировать некастомизируемое

            editingOrderItemId = orderItemId;
            selectedItem = { ...originalMenuItem }; // Загружаем данные базового товара
            addUpdateOrderBtn.textContent = "Обновить позицию"; // Меняем текст кнопки

            // Показываем/скрываем секции опций
            Object.keys(customizationOptionSections).forEach(optionType => {
                const section = customizationOptionSections[optionType];
                const container = customizationOptionsContainers[optionType];
                const isAvailable = selectedItem.options.includes(optionType);

                section.classList.toggle('visible', isAvailable);

                if (isAvailable && container && customizationData[optionType]) {
                    // Генерируем HTML и ВЫБИРАЕМ нужную опцию из itemToEdit.customizations
                     generateOptionsHTML(optionType, customizationData[optionType], itemToEdit.customizations[optionType]);
                } else if (container) {
                    container.innerHTML = '';
                }
            });


            customizationItemName.textContent = `Изменить: ${itemToEdit.name}`;
            updateCustomizationPrice(); // Обновляем цену для отображения
            showView('customization-view'); // Переходим на экран кастомизации
        }


        // Очистка заказа
        function handleClearOrder() {
            if (currentOrder.length > 0) {
                 if (confirm("Вы уверены, что хотите очистить весь заказ?")) {
                     currentOrder = [];
                     saveOrderToLocalStorage(); // Очищаем и хранилище
                     updateOrderSummary(); // Обновляем все (список, сумму, счетчик)
                     qrAndStatusSection.style.display = 'none';
                     orderStatusDisplay.textContent = 'Ожидание...';
                     orderStatusDisplay.className = '';
                     statusLoader.style.display = 'none';
                     showTemporaryMessage("Заказ очищен", "info");
                     updateOrderViewButtons(); // Обновить кнопки
                 }
            } else {
                 showTemporaryMessage("Заказ уже пуст", "info");
            }
        }

        // Оформление заказа (логика QR и статуса остается прежней)
        function handleCheckout() {
            if (currentOrder.length === 0) {
                showTemporaryMessage("Ваш заказ пуст. Добавьте что-нибудь!", "error");
                return;
            }

             // 1. Данные для QR (теперь включают quantity и строку кастомизации)
             const qrData = JSON.stringify({
                 orderId: `WEB-${Date.now()}`,
                 items: currentOrder.map(item => ({
                     name: item.name,
                     quantity: item.quantity,
                     customizations: item.customizationString || 'Стандарт',
                     pricePerItem: item.price,
                     totalItemPrice: item.price * item.quantity
                 })),
                 total: currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0)
             });

             // 2. Генерация QR кода (как раньше)
             qrCodeContainer.innerHTML = '';
             try {
                 new QRCode(qrCodeContainer, { text: qrData, width: 160, height: 160, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
             } catch (e) {
                 console.error("Ошибка генерации QR:", e);
                 qrCodeContainer.innerHTML = '<p style="color: red; font-size: 0.8em;">Ошибка генерации QR.</p>';
             }

            // 3. Показ QR и статуса
            qrAndStatusSection.style.display = 'block';

            // 4. Симуляция статуса (как раньше)
            simulateOrderStatus();

            // 5. Обновление кнопок
             updateOrderViewButtons(true); // Передаем флаг, что заказ оформлен

            // Блокировка корзины
             orderItemsList.style.pointerEvents = 'none';
             orderItemsList.querySelectorAll('.btn-decrease, .btn-increase, .btn-edit-item, .btn-remove-item').forEach(btn => btn.disabled = true); // Делаем кнопки неактивными

            showTemporaryMessage("Заказ оформлен! Следите за статусом.", "success");
        }

        // Симуляция статуса (как раньше)
        function simulateOrderStatus() { /* ... код без изменений ... */
             orderStatusDisplay.textContent = 'Заказ принят';
             orderStatusDisplay.className = 'status-pending';
             statusLoader.style.display = 'block';
             setTimeout(() => {
                  if (currentViewId !== 'order-view') return;
                 orderStatusDisplay.textContent = 'Готовится...';
                 orderStatusDisplay.className = 'status-processing';
             }, 4000);
             setTimeout(() => {
                 if (currentViewId !== 'order-view') return;
                 orderStatusDisplay.textContent = 'Готов к выдаче!';
                 orderStatusDisplay.className = 'status-ready';
                  statusLoader.style.display = 'none';
             }, 10000);
        }

        // Создание нового заказа
        function handleNewOrder() {
            currentOrder = [];
            selectedItem = null;
            editingOrderItemId = null;
            saveOrderToLocalStorage(); // Очищаем хранилище
            updateOrderSummary(); // Очистит список, сумму, счетчик
            qrCodeContainer.innerHTML = '';
            qrAndStatusSection.style.display = 'none';
             orderStatusDisplay.textContent = 'Ожидание...';
             orderStatusDisplay.className = '';
             statusLoader.style.display = 'none';
             orderItemsList.style.pointerEvents = 'auto'; // Разблокируем список
             // Разблокируем кнопки если они были заблокированы (хотя они удалятся при updateOrderSummary)
             // orderItemsList.querySelectorAll('.btn-decrease, .btn-increase, .btn-edit-item, .btn-remove-item').forEach(btn => btn.disabled = false);

            showView('menu-view'); // Переход в меню
        }

        // Обновление состояния кнопок в ВИДЕ ЗАКАЗА
        function updateOrderViewButtons(isOrderPlaced = false) {
            // Эта функция должна вызываться ТОЛЬКО когда активен вид 'order-view'
             // или принудительно сразу после checkout
             if (currentViewId !== 'order-view' && !isOrderPlaced) {
                 // Если мы не в корзине и не только что оформили заказ, сбрасываем кнопки
                 clearOrderBtn.style.display = 'none';
                 checkoutBtn.style.display = 'none';
                 newOrderBtn.style.display = 'none';
                 return;
             }

            const isOrderEmpty = currentOrder.length === 0;
            const orderHasBeenPlaced = isOrderPlaced || qrAndStatusSection.style.display === 'block'; // Проверяем по QR/статусу

            clearOrderBtn.style.display = !isOrderEmpty && !orderHasBeenPlaced ? 'inline-block' : 'none';
            checkoutBtn.style.display = !isOrderEmpty && !orderHasBeenPlaced ? 'inline-block' : 'none';
            newOrderBtn.style.display = orderHasBeenPlaced ? 'inline-block' : 'none';

            // Показ/скрытие сообщения о пустом заказе и самого контента
             emptyOrderMessage.style.display = isOrderEmpty && !orderHasBeenPlaced ? 'block' : 'none';
             orderContent.style.display = (isOrderEmpty && !orderHasBeenPlaced) ? 'none' : 'block'; // Скрываем если пусто и не оформлен

             // Управление QR/статусом
             if (!orderHasBeenPlaced) {
                 qrAndStatusSection.style.display = 'none';
                  orderItemsList.style.pointerEvents = 'auto'; // Разблокируем список
                  // Кнопки и так будут перерисованы в updateOrderSummary
             } else {
                 qrAndStatusSection.style.display = 'block'; // Убедимся, что показан, если оформлен
                  orderItemsList.style.pointerEvents = 'none'; // Блокируем список
             }
         }


        // --- Инициализация Приложения ---
        document.addEventListener('DOMContentLoaded', () => {
            loadOrderFromLocalStorage(); // Загружаем заказ ПЕРЕД первым рендерингом

            renderMenu(); // Рендерим меню
            updateOrderSummary(); // Обновляем корзину (даже если она скрыта) и счетчик в шапке
            showView(currentViewId); // Показываем начальный вид (обычно меню)

            // Обработчики для фильтров и поиска
            categoryFiltersContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-filter')) {
                    categoryFiltersContainer.querySelector('.active')?.classList.remove('active');
                    e.target.classList.add('active');
                    currentFilterCategory = e.target.dataset.category;
                    renderMenu(); // Перерисовать меню с новым фильтром
                }
            });
            menuSearchInput.addEventListener('input', (e) => {
                currentSearchTerm = e.target.value;
                renderMenu(); // Перерисовать меню при вводе
            });


            // Обработчики для изменения опций кастомизации
            Object.values(customizationOptionsContainers).forEach(container => {
                if(container) { // Проверка на null, если опция не найдена
                     container.addEventListener('change', updateCustomizationPrice);
                }
            });

            // Обработчики кнопок
            backToMenuBtn.addEventListener('click', () => showView('menu-view'));
            addUpdateOrderBtn.addEventListener('click', handleAddUpdateItem); // Используем новую общую функцию
            clearOrderBtn.addEventListener('click', handleClearOrder);
            checkoutBtn.addEventListener('click', handleCheckout);
            newOrderBtn.addEventListener('click', handleNewOrder);
            goToCartBtn.addEventListener('click', () => {
                // updateOrderSummary(); // Обновится при вызове updateOrderViewButtons внутри showView
                showView('order-view');
            });

            // Изначальное обновление кнопок корзины (на случай, если начнем с нее)
            updateOrderViewButtons();
        });

    </script>

</body>
</html>
